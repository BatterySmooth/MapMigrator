<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <title>Map Migrator</title>
</head>

<body>
  <div class="root">

    <div class="flex-item header container br">
      <h1 class="fw-light text-white m-0">Map Migrator</h1>
    </div>

    <div class="flex-item fileselect">
      <input type="file" name="file" id="file" class="inputfile" accept=".timber">
      <label for="file" class="br">Choose a file</label>
    </div>

  </div>




  <script>
    // Function to read a file as text asynchronously
    async function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    // Function to handle file selection
    function handleFileSelection() {
      const fileInput = document.getElementById('file');
      fileInput.addEventListener('change', async function (event) {
        if (event.target.files.length > 0) {
          const file = event.target.files[0];
          const fileName = file.name;
          JSZip.loadAsync(file)
            .then(zip => {
              // Find the file
              let foundFile = false;
              zip.forEach(function (relativePath, zipEntry) {
                // Check if the entry matches the file you're interested in
                if (relativePath === "world.json") {
                  foundFile = true; // Mark that we've found the file
                  zipEntry.async('string').then(function (fileContent) {
                    // Now you have the content of the file as a string
                    // You can modify it here if needed
                    const modifiedContent = processFile(fileContent);

                    // Write the modified content back to the zip file
                    //zip.file(relativePath, modifiedContent);

                    zip.generateAsync({ type: 'blob' }).then(function (content) {
                      // Create a link element and simulate click to download
                      var blob = content;
                      var link = document.createElement('a');
                      link.href = window.URL.createObjectURL(blob);
                      link.download = `${fileName}-U6.timber`;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                    });
                  });
                }
              });

            })
            .catch(err => {
              handleError(err, "Error loading zip file");
            });
        }
      });
    }

    function processFile(fileContent) {
      const worldJSON = JSON.parse(fileContent);
      const singletons = worldJSON.Singletons;
      const mapSize = {
        "X": singletons.MapSize.Size.X,
        "Y": singletons.MapSize.Size.Y
      };
      const waterMapOld = singletons.WaterMap;

      let waterMapNew = {};
      waterMapNew.Levels = 1;
      waterMapNew.WaterColumns = {
        "Array": Array(mapSize.X * mapSize.Y).fill('0:0:0:0').join(' ')
      };
      waterMapNew.ColumnOutflows = {
        "Array": Array(mapSize.X * mapSize.Y).fill('-1|0:-1|0:-1|0:-1|0').join(' ')
      }

      delete worldJSON.Singletons.WaterMap;
      worldJSON.Singletons.WaterMapNew = waterMapNew;

      modifiedContent = JSON.stringify(worldJSON);

      return modifiedContent;
    }

    function handleError(error, errorTitle = "") {
      console.error(`${errorTitle}:`, error);
    }

    // Initialize the file picker handler
    window.addEventListener('DOMContentLoaded', handleFileSelection);
  </script>


</body>

</html>
